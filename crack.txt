# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHH⢻HHHHHHHHHHHHH⡏H⡙⢿HHHHHHHHHHHHHHHHHHHHHH⡽HHHHHHH⢹HHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHH⠀HHHHHHHH⠙HHHH⡇HH⠀⠈⠻⢿HHHHHHHHHH⡇HHHH⢸H⡏H⣷⠘⢿HHHH⡏⣼HHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHH⠀⣹HHHHHH⡏⠀⢻HH⣷⠀⢱H⠀⣷⡄⠀HHHHH⠿⠿⠿HH⡇⢻HHH⢸H⡀⠀H⡇⠈HHH⡏⢠HHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHH⠇HHHHHHH⠇⡄⠸HHH⡀⢸H⠀H⣧⠀⢻HH⠏⢀⣤⣤⠀⢸H⡇⠈⢻H⡇⢸H⡇⢸HH⡄⠹H⡿⢁HHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHH⠇HHHHHHH⢠H⠀⠻⣛⣽⡇⢸H⠀HH⣷⡀⢿⡿⠀HHH⡇⠀⢹⡇⢰⠀⠹⡇⢸H⡇⢸HHH⡄⠙⠁⣼HHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHH⠀HHHHH⡿⠇⢈⣥⣄⠸HH⡇⢸H⡆HH⠿⠃⣸⡇⢀HHHH⡆⠈⡇⢸⣷⡄⠙⠘H⡇⢸HHH⡿⠀⠸HHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHH⠀HHHH⣷⣾⢁HHH⡀HH⡇⢘⣛⡃⠉⠁⢴⣾H⣷⠀HHHH⡇⢠⣇⢸H⣷⡄⠀H⡇⢸HH⡿⠁⣴⡄⢻HHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHH⡇⢻HHH⠿⡛⢸HHH⣇⢻H⡇⣸H⡇⢸H⣦⡈⠻H⣧⡜H⡿⢋⣴H⡏⢸HHH⠀H⣇⢸HH⠃⣾HH⡀⢿HHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHH⠇⠸⠟⢋⣤⣾⠃⣾HHHH⡼H⣧HH⡇⣾HHH⡄HHH⣶⣶HHH⣇⢻HHH⢸HH⣼H⠃⣼HHH⣷⡈HHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHH⡿⠀⣀⣴HHH⢸HHHHH⣇HHHH⡇HHHH⡇⢸HHHHHHHH⢸HHH⢸HHH⣏⣼HHHHH⣧⡸HHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHH⣵HHHHH⣯HHHHHHH⣾HHH⣟HHHH⣟⢾HHHHHHHH⣾HHH⢸HH⡿⣾HHHHHHH⣷HHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH⣼HHHHHHHHHHHH⣼HHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH
# * HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH

# Name: MamaYaDokserSherlack
# Author: @tu2de (laironix)
# Commands: .dox

__version__ = (2, 2, 0)

import datetime
import logging
import asyncio
import re
from telethon.tl.functions.messages import DeleteHistoryRequest, ForwardMessagesRequest
from .. import loader, utils

logger = logging.getLogger(__name__)

@loader.tds
class MamaYaDokserSherlack(loader.Module):
    """Осень мощный доксер на базе Шерлока"""
    strings = {
        "name": "MamaYaDokserSherlack",
        "limit_reached": "Лимит на сегодня исчерпан, возвращайся завтра.",
        "no_reply": "Команда должна быть в ответ на сообщение пользователя с username.",
        "searching": "Я мамкин доксер Я таби найду!",
        "result_header": "<b>Результаты докса для @{username} (ID: {id})</b>\n\n",
        "tg_data": "<b>Данные из Telegram:</b>\n{data}\n\n",
        "phones_found": "<b>Найденные телефоны:</b>\n{phones}\n\n",
        "search_links": "<b>Ссылки для дальнейшего поиска по открытым источникам:</b>\n{links}"
    }

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        self.daily_limits = {}
        self.phone_regex = re.compile(r"(\+?\d{1,3}?[ -]?\(?\d{3}\)?[ -]?\d{3}[ -]?\d{4})|(\+?\d{10,15})")

    async def doxcmd(self, message):
        reply = await message.get_reply_message()
        if not reply or not reply.sender or not getattr(reply.sender, "username", None):
            await utils.answer(message, self.strings["no_reply"])
            return

        target = reply.sender
        username = target.username
        user_id = target.id

        today = datetime.date.today().isoformat()
        if self.daily_limits.get(user_id, {}).get(today, 0) >= 15:
            await utils.answer(message, self.strings["limit_reached"])
            return

        await utils.answer(message, self.strings["searching"])
        await message.edit(self.strings["searching"] + "\n\n<i>Начинаю поиск...</i>")

        bots = ["@userinfobot", "@SangMataInfo_bot", "@creationdatebot"]
        for bot in bots:
            await self.clear_chat_with_bot(bot)

        tg_data = f"Username: @{username}\nUser ID: {user_id}\n\n"
        found_phones = set()

        for bot in bots:
            try:
                await self.client.send_message(bot, f"@{username}")
                await asyncio.sleep(6)
                history = await self.client.get_messages(bot, limit=15)
                for msg in history:
                    if msg.message:
                        text = msg.message
                        if username.lower() in text.lower() or str(user_id) in text:
                            tg_data += text + "\n\n"
                            phones = self.phone_regex.findall(text)
                            for phone_group in phones:
                                phone = "".join(filter(str.isdigit, "".join(phone_group)))
                                if len(phone) >= 10:
                                    cleaned = "+" + phone if not phone.startswith("1") else "+1" + phone[1:] if phone.startswith("1") and len(phone) > 10 else "+1" + phone
                                    found_phones.add(cleaned)
            except Exception as e:
                logger.error(f"Ошибка с ботом {bot}: {e}")

        links = ""
        services = [
            ("TruePeopleSearch", "https://www.truepeoplesearch.com/results?name={name}&phoneno={phone}"),
            ("FastPeopleSearch", "https://www.fastpeoplesearch.com/name/{name}"),
            ("ThatsThem", "https://thatsthem.com/phone/{phone}"),
            ("Whitepages", "https://www.whitepages.com/phone/{phone}"),
            ("Spokeo", "https://www.spokeo.com/{phone}?g=header_phone_search"),
            ("NumLookup", "https://www.numlookup.com/{phone}"),
            ("SpyDialer", "https://www.spydialer.com/default.aspx?search={phone}"),
        ]

        if found_phones:
            phones_list = "\n".join(sorted(found_phones))
            for phone in found_phones:
                clean_phone = phone.lstrip("+")
                for name, url_template in services:
                    url = url_template.format(phone=clean_phone, name=username.replace("@", ""))
                    links += f"<a href='{url}'>{name} ({phone})</a>\n"
        else:
            phones_list = "Не найдено"
            for name, url_template in services:
                url = url_template.format(phone="", name=username.replace("@", ""))
                links += f"<a href='{url}'>{name} (по username)</a>\n"

        final_text = (
            self.strings["result_header"].format(username=username, id=user_id) +
            self.strings["tg_data"].format(data=tg_data) +
            self.strings["phones_found"].format(phones=phones_list) +
            self.strings["search_links"].format(links=links)
        )

        # Исправлено: без disable_web_page_preview, добавлен parse_mode
        dox_msg = await self.client.send_message(message.chat_id, final_text, parse_mode='html')

        await self.client(ForwardMessagesRequest(
            from_peer=message.chat_id,
            id=[dox_msg.id],
            to_peer="me"
        ))

        for bot in bots:
            await self.clear_chat_with_bot(bot)

        if user_id not in self.daily_limits:
            self.daily_limits[user_id] = {}
        self.daily_limits[user_id][today] = self.daily_limits[user_id].get(today, 0) + 1

    async def clear_chat_with_bot(self, bot_username):
        try:
            entity = await self.client.get_entity(bot_username)
            await self.client(DeleteHistoryRequest(peer=entity, max_id=0, just_clear=True))
        except Exception as e:
            logger.error(f"Ошибка очистки чата с {bot_username}: {e}")
